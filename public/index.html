<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>gxpt 平台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc;}
    .card{border-radius:10px;}
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4>gxpt 服务平台</h4>
    <div id="authArea">
      <button class="btn btn-outline-primary btn-sm" id="btnLogin">登录</button>
      <button class="btn btn-outline-secondary btn-sm" id="btnRegister">注册</button>
      <button class="btn btn-danger btn-sm d-none" id="btnLogout">退出</button>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card p-3 mb-3">
        <h6>发布信息</h6>
        <select id="type" class="form-select mb-2"><option value="supply">供给</option><option value="demand">需求</option></select>
        <input id="title" class="form-control mb-2" placeholder="标题">
        <textarea id="content" class="form-control mb-2" rows="3" placeholder="描述"></textarea>
        <input id="keywords" class="form-control mb-2" placeholder="关键词，逗号分隔">
        <input id="start_time" class="form-control mb-2" type="datetime-local">
        <input id="end_time" class="form-control mb-2" type="datetime-local">
        <button id="btnPublish" class="btn btn-primary w-100">发布</button>
        <div id="pubMsg" class="mt-2 text-success"></div>
      </div>

      <div class="card p-3">
        <h6>我的发布</h6>
        <div id="myPosts"></div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3 mb-3">
        <div class="input-group">
          <input id="searchInput" class="form-control" placeholder="输入关键词（例如：草莓）">
          <button id="btnSearch" class="btn btn-outline-primary">搜索</button>
        </div>
      </div>

      <div id="results" class="row gy-3"></div>
    </div>
  </div>
</div>

<!-- auth modal -->
<div class="modal fade" id="authModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="authTitle">登录</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="authUser" class="form-control mb-2" placeholder="用户名"><input id="authPass" type="password" class="form-control" placeholder="密码"></div><div class="modal-footer"><button id="authSubmit" class="btn btn-primary">提交</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "https://gxpt.wendong.work:3000/api";
function setToken(t){ if(t) localStorage.setItem('gxpt_token', t); else localStorage.removeItem('gxpt_token'); updateAuthUI(); }
function getToken(){ return localStorage.getItem('gxpt_token'); }
function updateAuthUI(){ if(getToken()){ document.getElementById('btnLogin').classList.add('d-none'); document.getElementById('btnRegister').classList.add('d-none'); document.getElementById('btnLogout').classList.remove('d-none'); } else { document.getElementById('btnLogin').classList.remove('d-none'); document.getElementById('btnRegister').classList.remove('d-none'); document.getElementById('btnLogout').classList.add('d-none'); } }

document.getElementById('btnLogin').onclick = ()=>showAuth('login');
document.getElementById('btnRegister').onclick = ()=>showAuth('register');
document.getElementById('btnLogout').onclick = ()=>{ setToken(null); location.reload(); };

function showAuth(mode){ const modal = new bootstrap.Modal(document.getElementById('authModal')); document.getElementById('authTitle').innerText = mode==='login'?'登录':'注册'; document.getElementById('authSubmit').onclick = ()=>authSubmit(mode); modal.show(); }
async function authSubmit(mode){ const u=document.getElementById('authUser').value, p=document.getElementById('authPass').value; if(!u||!p) return alert('请输入用户名和密码'); const url = API + '/auth/' + (mode==='login'?'login':'register'); const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u,password:p})}); const data = await res.json(); if(data.token){ setToken(data.token); alert('登录成功'); location.reload(); } else if(data.ok){ alert(data.message||'操作成功'); } else { alert(data.error||'出错'); } }

document.getElementById('btnPublish').onclick = async ()=>{
  const t=getToken(); if(!t) return alert('请先登录'); const payload={ type:document.getElementById('type').value, title:document.getElementById('title').value, content:document.getElementById('content').value, keywords:document.getElementById('keywords').value, start_time:document.getElementById('start_time').value || null, end_time:document.getElementById('end_time').value || null };
  const res = await fetch(API + '/messages/publish', {method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+t}, body:JSON.stringify(payload)});
  const data = await res.json(); if(data.ok){ document.getElementById('pubMsg').innerText='发布成功'; loadMyPosts(); } else alert(data.error||'发布失败');
};

document.getElementById('btnSearch').onclick = async ()=>{ const q=document.getElementById('searchInput').value; const res=await fetch(API + '/messages/search?q=' + encodeURIComponent(q)); const data=await res.json(); const container=document.getElementById('results'); container.innerHTML=''; (data.results||[]).forEach(it=>{ const col=document.createElement('div'); col.className='col-md-6'; col.innerHTML=`<div class="card p-3"><h5>${it.title} <small class="text-muted">[${it.type}]</small></h5><div>${it.content||''}</div><div class="mt-2"><small class="text-muted">关键词: ${it.keywords}</small></div><div class="mt-2 text-end"><small class="text-muted">发布: ${it.created_at}</small></div></div>`; container.appendChild(col); }); };

async function loadMyPosts(){ const t=getToken(); if(!t) return; const res=await fetch(API + '/messages/my', {headers:{'Authorization':'Bearer '+t}}); const data=await res.json(); const el=document.getElementById('myPosts'); el.innerHTML=''; (data.results||[]).forEach(it=>{ const div=document.createElement('div'); div.className='mb-2'; div.innerHTML=`<b>${it.title}</b><div class="text-muted">${it.keywords} · ${it.status}</div>`; el.appendChild(div); }); }

window.addEventListener('load', ()=>{ updateAuthUI(); loadMyPosts(); });
</script>
</body>
</html>
